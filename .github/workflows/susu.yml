name: Build Aetherium1.0-SuSu (Android 14 - Kernel 6.1 + SukiSU)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build:
    name: Build Aetherium1.0-SuSu Kernel
    runs-on: ubuntu-22.04
    timeout-minutes: 300

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies (Optimized)
        run: |
          sudo apt update -qq
          sudo apt install -y git curl python3 python3-pip openjdk-11-jdk zip unzip bc bison flex \
            build-essential ccache libncurses-dev libssl-dev lld repo rsync jq neovim
          python3 -m pip install --upgrade pip
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Initialize Android 14 Kernel Source (6.1)
        run: |
          mkdir kernel_build && cd kernel_build
          echo "==> Initializing Android14-6.1 manifest..."
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1-2025-09
          repo sync -c --no-tags --no-clone-bundle --optimized-fetch --force-sync

      - name: Apply SukiSU Quick Setup (Auto Patch)
        run: |
          cd kernel_build/common
          echo "==> Running SukiSU quick setup (auto KPM + SUSFS + Zakosu)..."
          curl -LSs "https://raw.githubusercontent.com/Lama3L9R/sukisu-quick-setup/master/zako-zako-zako.sh" | bash -s || true
          echo "==> SukiSU applied (warnings ignored)."

      - name: Fix Config & Local Version
        run: |
          cd kernel_build/common
          echo "" > scripts/setlocalversion
          chmod +x scripts/setlocalversion
          sed -i '/CONFIG_KALLSYMS_ALL/d' arch/arm64/configs/gki_defconfig || true
          sed -i '/CONFIG_KPM/d' arch/arm64/configs/gki_defconfig || true
          echo "CONFIG_KPM=y" >> arch/arm64/configs/gki_defconfig
          echo "export LOCALVERSION=-Aetherium1.0-SuSu" >> .bazelrc
          echo "==> Config & version fixed."

      - name: Prepare Bazel Cache
        run: |
          cd kernel_build/common
          export CCACHE_DIR=$HOME/.ccache
          export CCACHE_COMPRESS=1
          export CCACHE_MAXSIZE=10G
          ccache -z

      - name: Build Kernel with Bazel
        run: |
          cd kernel_build/common
          echo "==> Starting Bazel build for Aetherium1.0-SuSu..."
          bazel clean
          bazel build //common:kernel_aarch64 --verbose_failures || exit 1
          echo "==> Build done."
          find bazel-bin -type f -name "Image" || true

      - name: Upload Built Image to Pixeldrain
        env:
          PIXELDRAIN_TOKEN: 23c84c82-ce06-4e35-bc1f-69eaa13b9958
        run: |
          cd kernel_build/common
          IMAGE_PATH=$(find bazel-bin -type f -name "Image" | head -n 1)
          if [ -f "$IMAGE_PATH" ]; then
            echo "==> Uploading Image to Pixeldrain..."
            RESPONSE=$(curl -s -u :${PIXELDRAIN_TOKEN} -F file=@"$IMAGE_PATH" https://pixeldrain.com/api/file)
            echo "$RESPONSE" | jq .
            echo "Pixeldrain URL:"
            echo "$RESPONSE" | jq -r '.url'
          else
            echo "ERROR: Image not found!"
            exit 1
          fi

      - name: Show ccache Stats
        run: ccache -s
